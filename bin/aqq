#!/usr/bin/env bash

function argfiles {
  local pth_cache="$1"; shift

  (
    cd "$pth_cache"
    set +f
    local a
    for a in *; do
      if [[ ! -f "$a" ]]; then
        continue
      fi
      printf ' --argfile %q %q' "$(echo "${a#describe-}" | tr - _)" "$pth_cache/$a"
    done
  )
}

function main {
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"
  source "${BLOCK_PATH:-"$shome/work"}/block/script/profile" ~
  source normalize  

  local pth_cache="$(mktemp -d -t XXXXXX)"
  trap "$(printf 'rm -rf %q' "$pth_cache")" EXIT

  (
    cd "$pth_cache"
    aq describe-instances > describe-instances &
    aq describe-volumes > describe-volumes &
    aq describe-snapshots --owner self > describe-snapshots &
    aq describe-images --owner self > describe-images &
    wait
  )
  jq -n $(argfiles "$pth_cache") '
      $instances | .Reservations[].Instances[].BlockDeviceMappings[].Ebs |= . + {Volume: $volumes.Volumes[.VolumeId]}
    '
}

source sub "$BASH_SOURCE" "$@"
